# [201_71] 修复点击网络 .tmu 链接时 UI 冻结的问题并添加 HTTP 超时机制

## 如何测试

1. 打开模板中心：`帮助` -> `模板`
2. 按住 Ctrl 键（macOS 为 Command 键）并点击指向 .tmu 文件的链接
3. 观察行为：
   - **修复前**：界面直接冻结，直到文件下载完成或超时（默认5分钟）
   - **修复后**：立即显示"Loading remote file..."等待对话框，然后下载文件，完成后对话框自动消失
4. 测试超时：可以断开网络或输入一个不存在的 URL，应该在 10 秒内（连接超时）或 30 秒内（总超时）看到失败提示

## 2026/02/02

### What
修复点击网络 .tmu 链接时 UI 冻结的问题，并为 HTTP 操作添加超时机制。

### How

#### 1. 修复 UI 冻结问题

问题根源：`load-browse-buffer` 对网络 URL 直接调用 `load-buffer`，而 `load-buffer` -> `import_tree` -> `tm_load_string` -> `get_from_web` 是同步阻塞的 HTTP 下载，导致主线程被阻塞，UI 无法响应。

修复方案分两步：

**Scheme 层** (`TeXmacs/progs/texmacs/texmacs/tm-files.scm`)：
```scheme
((url-rooted-web? name)
 ;; Show wait dialog during remote file loading
 (system-wait "Loading remote file" (url->system name))
 (load-buffer name))
```
使用 `system-wait` 显示等待对话框，在 `load-buffer` 执行前显示。

**C++ 层** (`src/System/Files/web_files.cpp`)：
```cpp
#ifdef QTTEXMACS
  // Process pending events to ensure the wait dialog is rendered
  // before the synchronous download blocks the main thread
  qApp->processEvents (QEventLoop::ExcludeUserInputEvents);
#endif
```
在 `get_from_web` 开始下载前调用 `processEvents()`，强制 Qt 处理待处理的事件，确保等待窗口的内容得以渲染。

#### 2. 添加 HTTP 超时机制

**C++ 层** (`3rdparty/lolly/lolly/io/http.cpp`)：

参考 curl 的默认超时值：
- `CURLOPT_TIMEOUT`: 默认为 0（无限制）- https://curl.se/libcurl/c/CURLOPT_TIMEOUT.html
- `CURLOPT_CONNECTTIMEOUT`: 默认为 300 秒 - https://curl.se/libcurl/c/CURLOPT_CONNECTTIMEOUT.html

设置合理的超时值（cpr 库使用 curl 作为后端）：
```cpp
// Timeout settings for HTTP operations (in milliseconds)
// Total timeout: 30 seconds (reasonable for downloading small to medium files)
// Connect timeout: 10 seconds (fail fast if server is unreachable)
constexpr long HTTP_TIMEOUT_MS= 30000;
constexpr long HTTP_CONNECT_TIMEOUT_MS= 10000;
```

应用于所有 HTTP 操作函数 (`http_get`, `http_head`, `download`)：
```cpp
session.SetTimeout (cpr::Timeout{HTTP_TIMEOUT_MS});
session.SetConnectTimeout (cpr::ConnectTimeout{HTTP_CONNECT_TIMEOUT_MS});
```

**设计理由**：
- **10 秒连接超时**：如果服务器不可达或网络不通，用户会在 10 秒内收到失败提示，不会长时间卡住（相比 curl 默认 300 秒大幅降低）
- **30 秒总超时**：对于模板中心的小型 .tmu 文件（通常几KB到几百KB），30秒足够下载完成；如果超过30秒还没下完，说明网络状况很差，应该放弃
